<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Picanter√≠a v2.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      :root {
        --primary: #d35400; /* Naranja Picanter√≠a */
        --dark: #2c3e50;    /* Azul Oscuro */
        --light: #f4f6f9;
        --success: #27ae60;
      }

      body { background-color: var(--light); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
      
      /* LAYOUT */
      #wrapper { display: flex; width: 100%; height: 100vh; }
      
      /* SIDEBAR */
      #sidebar {
        min-width: 260px; max-width: 260px;
        background: var(--dark); color: #fff;
        transition: all 0.3s;
      }
      .sidebar-header { padding: 20px; background: rgba(0,0,0,0.2); text-align: center; border-bottom: 3px solid var(--primary); }
      .menu-btn {
        width: 100%; text-align: left; padding: 15px 20px;
        background: transparent; border: none; color: #bdc3c7;
        font-size: 1.1rem; transition: 0.2s;
      }
      .menu-btn:hover, .menu-btn.active { background: var(--primary); color: white; padding-left: 25px; }
      .menu-btn i { width: 30px; }

      /* MAIN CONTENT */
      #content { width: 100%; overflow-y: auto; padding: 0; display: flex; flex-direction: column; }
      .top-bar { background: white; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }

      /* POS (CAJA) */
      .product-card {
        cursor: pointer; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.2s; height: 100%;
      }
      .product-card:hover { transform: translateY(-5px); border: 2px solid var(--primary); }
      .price-badge {
        position: absolute; top: 10px; right: 10px;
        background: var(--primary); color: white; padding: 3px 10px;
        border-radius: 20px; font-weight: bold;
      }
      .ticket-panel { height: calc(100vh - 80px); display: flex; flex-direction: column; }
      .ticket-list { flex-grow: 1; overflow-y: auto; background: white; }
      
      /* COCINA */
      .kitchen-card { border-left: 6px solid #f1c40f; margin-bottom: 15px; animation: fadeIn 0.5s; }
      .kitchen-header { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
      
      /* ANIMACIONES */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .d-none { display: none !important; }
    </style>
  </head>
  <body>

    <div id="wrapper">
      <nav id="sidebar">
        <div class="sidebar-header">
          <h3><i class="fas fa-utensils"></i> SYSTEM POS</h3>
          <small>Picanter√≠a & Mariscos</small>
        </div>
        <div class="mt-4">
          <button class="menu-btn active" onclick="nav('venta')"><i class="fas fa-cash-register"></i> Caja / Ventas</button>
          <button class="menu-btn" onclick="nav('cocina')"><i class="fas fa-fire-burner"></i> Monitor Cocina</button>
          <button class="menu-btn" onclick="nav('finanzas')"><i class="fas fa-chart-line"></i> Ingresos / Egresos</button>
          <button class="menu-btn" onclick="nav('admin')"><i class="fas fa-boxes"></i> Productos</button>
        </div>
      </nav>

      <div id="content">
        <div class="top-bar">
          <button class="btn btn-outline-secondary btn-sm" id="toggle-sidebar"><i class="fas fa-bars"></i></button>
          <span class="fw-bold text-secondary" id="clock">00:00:00</span>
        </div>

        <div class="container-fluid p-4">
          
          <div id="view-venta" class="view-section">
            <div class="row h-100">
              <div class="col-md-7">
                <input type="text" id="search-prod" class="form-control form-control-lg mb-3" placeholder="üîç Buscar plato..." onkeyup="filtrarProductos()">
                <div class="row g-3" id="grid-productos">
                  <div class="text-center mt-5"><i class="fas fa-spinner fa-spin fa-3x text-muted"></i><p>Cargando men√∫...</p></div>
                </div>
              </div>
              
              <div class="col-md-5">
                <div class="card ticket-panel shadow">
                  <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <span><i class="fas fa-receipt"></i> Orden Actual</span>
                    <button class="btn btn-sm btn-danger" onclick="limpiarCarrito()"><i class="fas fa-trash"></i></button>
                  </div>
                  <div class="ticket-list p-0">
                    <table class="table table-striped table-hover mb-0">
                      <thead class="table-light sticky-top">
                        <tr><th>Cant</th><th>Prod</th><th>Total</th><th></th></tr>
                      </thead>
                      <tbody id="cart-body">
                        </tbody>
                    </table>
                  </div>
                  <div class="card-footer bg-white p-3">
                    <div class="d-flex justify-content-between h4 fw-bold">
                      <span>Total:</span>
                      <span class="text-success" id="cart-total">$0.00</span>
                    </div>
                    <button class="btn btn-success w-100 py-3 fw-bold mt-2" onclick="abrirModalCobro()">
                      COBRAR <i class="fas fa-arrow-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="view-cocina" class="view-section d-none">
            <h3 class="border-bottom pb-2 text-secondary">Comandas en Preparaci√≥n <i class="fas fa-sync fa-spin ms-2 small" style="font-size:0.6em"></i></h3>
            <div class="row mt-3" id="kitchen-board">
              <div class="col-12 text-center text-muted">Esperando pedidos...</div>
            </div>
          </div>

          <div id="view-finanzas" class="view-section d-none">
             <div class="card shadow p-4" style="max-width: 600px; margin: auto;">
               <h4 class="text-danger mb-4"><i class="fas fa-wallet"></i> Registrar Egreso (Gasto)</h4>
               <form id="form-egreso">
                 <div class="mb-3">
                   <label>Concepto</label>
                   <input type="text" id="egreso-desc" class="form-control" placeholder="Ej: Compras de mariscos">
                 </div>
                 <div class="mb-3">
                   <label>Categor√≠a</label>
                   <select id="egreso-cat" class="form-select">
                     <option>Insumos / Mercado</option>
                     <option>Personal</option>
                     <option>Servicios</option>
                     <option>Mantenimiento</option>
                   </select>
                 </div>
                 <div class="mb-3">
                   <label>Monto ($)</label>
                   <input type="number" step="0.01" id="egreso-monto" class="form-control" placeholder="0.00">
                 </div>
                 <button type="button" class="btn btn-danger w-100" onclick="registrarEgreso()">Guardar Gasto</button>
               </form>
             </div>
          </div>
          
          <div id="view-admin" class="view-section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
               <h3>Gesti√≥n de Productos</h3>
               <button class="btn btn-primary" onclick="new bootstrap.Modal('#modalProducto').show()"><i class="fas fa-plus"></i> Nuevo Producto</button>
            </div>
            <div class="card">
               <div class="card-body">
                 <p class="text-muted">Aqu√≠ aparecer√° la tabla completa de productos para editar (Pr√≥xima actualizaci√≥n).</p>
               </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="modal fade" id="modalCobro" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Finalizar Venta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <h1 class="text-center fw-bold text-success display-4" id="modal-total-display">$0.00</h1>
            <hr>
            
            <div class="mb-3">
              <label class="fw-bold">Identificaci√≥n (Mesa o Nombre)</label>
              <input type="text" id="cobro-mesa" class="form-control form-control-lg text-center" placeholder="Ej: Mesa 5 / Sr. Juan">
            </div>

            <div class="mb-3">
               <label class="fw-bold mb-2">M√©todo de Pago</label>
               <div class="row g-2">
                 <div class="col-4">
                   <input type="radio" class="btn-check" name="metodoPago" id="mp-efectivo" value="Efectivo" checked>
                   <label class="btn btn-outline-secondary w-100" for="mp-efectivo"><i class="fas fa-money-bill"></i> Efectivo</label>
                 </div>
                 <div class="col-4">
                   <input type="radio" class="btn-check" name="metodoPago" id="mp-transf" value="Transferencia">
                   <label class="btn btn-outline-secondary w-100" for="mp-transf"><i class="fas fa-mobile"></i> Transf.</label>
                 </div>
                 <div class="col-4">
                   <input type="radio" class="btn-check" name="metodoPago" id="mp-tarjeta" value="Tarjeta">
                   <label class="btn btn-outline-secondary w-100" for="mp-tarjeta"><i class="fas fa-credit-card"></i> Tarjeta</label>
                 </div>
               </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-lg btn-success w-100 fw-bold" onclick="procesarVentaReal()">‚úÖ CONFIRMAR Y ENVIAR A COCINA</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalProducto" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title">Nuevo Plato</h5>
          </div>
          <div class="modal-body">
             <input type="text" id="np-nombre" class="form-control mb-2" placeholder="Nombre del Plato">
             <input type="number" id="np-precio" class="form-control mb-2" placeholder="Precio ($)">
             <select id="np-cat" class="form-select">
               <option>Plato Fuerte</option>
               <option>Sopa</option>
               <option>Bebida</option>
               <option>Entrada</option>
             </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary w-100" onclick="guardarNuevoProducto()">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- VARIABLES GLOBALES ---
      let carrito = [];
      let productosDB = []; // Se llena desde el servidor
      
      // --- INICIALIZACI√ìN ---
      window.onload = function() {
        actualizarReloj();
        setInterval(actualizarReloj, 1000);
        cargarProductos();      // Traer productos de Sheets
        iniciarPollingCocina(); // Activar el "tiempo real"
      };

      function nav(vista) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        document.getElementById('view-' + vista).classList.remove('d-none');
        
        document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
      }

      function actualizarReloj() {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
      }

      // --- LOGICA DEL POS (CAJA) ---
      function cargarProductos() {
        google.script.run.withSuccessHandler((res) => {
          productosDB = res;
          renderProductos(productosDB);
        }).getProductos();
      }

      function renderProductos(lista) {
        const grid = document.getElementById('grid-productos');
        grid.innerHTML = "";
        lista.forEach(p => {
          grid.innerHTML += `
            <div class="col-6 col-lg-3 col-md-4">
              <div class="card product-card p-3 text-center" onclick="addToCart('${p.id}', '${p.nombre}', ${p.precio})">
                <span class="price-badge">$${p.precio.toFixed(2)}</span>
                <div class="display-4 text-primary mb-2"><i class="fas fa-utensils"></i></div>
                <h6 class="fw-bold mb-0">${p.nombre}</h6>
                <small class="text-muted">${p.categoria}</small>
              </div>
            </div>`;
        });
      }

      function filtrarProductos() {
        const term = document.getElementById('search-prod').value.toLowerCase();
        const filtrados = productosDB.filter(p => p.nombre.toLowerCase().includes(term));
        renderProductos(filtrados);
      }

      function addToCart(id, nombre, precio) {
        const existente = carrito.find(item => item.id === id);
        if(existente) {
          existente.cantidad++;
        } else {
          carrito.push({ id, nombre, precio, cantidad: 1 });
        }
        renderCart();
      }

      function renderCart() {
        const tbody = document.getElementById('cart-body');
        tbody.innerHTML = "";
        let total = 0;
        
        carrito.forEach((item, index) => {
          const subtotal = item.precio * item.cantidad;
          total += subtotal;
          tbody.innerHTML += `
            <tr>
              <td><input type="number" min="1" value="${item.cantidad}" style="width:50px" onchange="updateCant(${index}, this.value)"></td>
              <td>${item.nombre}</td>
              <td>$${subtotal.toFixed(2)}</td>
              <td><i class="fas fa-times text-danger" style="cursor:pointer" onclick="removeFromCart(${index})"></i></td>
            </tr>`;
        });
        
        document.getElementById('cart-total').innerText = "$" + total.toFixed(2);
        document.getElementById('modal-total-display').innerText = "$" + total.toFixed(2);
      }

      function updateCant(index, val) {
        if(val < 1) return;
        carrito[index].cantidad = parseInt(val);
        renderCart();
      }

      function removeFromCart(index) {
        carrito.splice(index, 1);
        renderCart();
      }
      
      function limpiarCarrito() {
        carrito = [];
        renderCart();
      }

      // --- LOGICA DE COBRO ---
      function abrirModalCobro() {
        if(carrito.length === 0) return alert("Carrito vac√≠o");
        const modal = new bootstrap.Modal(document.getElementById('modalCobro'));
        modal.show();
      }

      function procesarVentaReal() {
        const mesa = document.getElementById('cobro-mesa').value;
        if(!mesa) return alert("Por favor indica la Mesa o Cliente");
        
        const metodo = document.querySelector('input[name="metodoPago"]:checked').value;
        const total = parseFloat(document.getElementById('cart-total').innerText.replace('$',''));
        
        const venta = {
          mesa: mesa,
          metodo: metodo,
          total: total,
          items: carrito
        };
        
        // Bloquear bot√≥n
        document.querySelector('#modalCobro .btn-success').disabled = true;
        document.querySelector('#modalCobro .btn-success').innerText = "Procesando...";

        google.script.run.withSuccessHandler((res) => {
          alert("‚úÖ " + res);
          location.reload(); // Recargar para limpiar todo
        }).registrarVentaCompleta(venta);
      }

      // --- LOGICA DE COCINA (TIEMPO REAL) ---
      function iniciarPollingCocina() {
        setInterval(() => {
          // Solo si estamos viendo la cocina
          if(!document.getElementById('view-cocina').classList.contains('d-none')){
             google.script.run.withSuccessHandler(renderCocina).getPedidosCocina();
          }
        }, 5000); // 5 segundos
      }

      function renderCocina(pedidos) {
        const board = document.getElementById('kitchen-board');
        if(pedidos.length === 0) {
          board.innerHTML = '<div class="col-12 text-center text-muted mt-5"><h4>Todo Despachado ‚úÖ</h4></div>';
          return;
        }

        // Generar HTML
        let html = "";
        pedidos.forEach(p => {
           html += `
             <div class="col-md-4 col-sm-6">
               <div class="card shadow-sm kitchen-card p-3">
                 <div class="kitchen-header">
                   <span class="text-primary"><i class="fas fa-map-marker-alt"></i> ${p.mesa}</span>
                   <small>${p.hora}</small>
                 </div>
                 <h4 class="fw-bold">${p.cantidad}x ${p.producto}</h4>
                 <div class="mt-3">
                   <button class="btn btn-success w-100" onclick="despacharItem('${p.id_detalle}')">MARCAR LISTO</button>
                 </div>
               </div>
             </div>`;
        });
        
        // Solo actualizar si hay cambios (para no molestar la vista)
        if(board.innerHTML !== html) board.innerHTML = html;
      }

      function despacharItem(id) {
        google.script.run.withSuccessHandler(() => {
          // Forzar actualizaci√≥n inmediata
          google.script.run.withSuccessHandler(renderCocina).getPedidosCocina();
        }).marcarDespachado(id);
      }

      // --- LOGICA ADMIN (NUEVO PRODUCTO) ---
      function guardarNuevoProducto() {
        const data = {
          nombre: document.getElementById('np-nombre').value,
          precio: document.getElementById('np-precio').value,
          categoria: document.getElementById('np-cat').value
        };
        
        google.script.run.withSuccessHandler(() => {
          alert("Producto creado");
          location.reload();
        }).guardarNuevoProducto(data);
      }

      // --- LOGICA FINANZAS ---
      function registrarEgreso() {
        const data = {
           desc: document.getElementById('egreso-desc').value,
           cat: document.getElementById('egreso-cat').value,
           monto: document.getElementById('egreso-monto').value
        };
        google.script.run.withSuccessHandler(() => {
          alert("Gasto registrado");
          document.getElementById('form-egreso').reset();
        }).registrarEgreso(data);
      }

    </script>
  </body>
</html>
